<!DOCTYPE html>
<html>
<head>
    <title>–ê–¥–º–∏–Ω–∫–∞ –¢–∞–±–ª–æ</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f4; }
        .admin-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; gap: 20px; align-items: center; }
        button { padding: 10px; cursor: pointer; }
        .btn-active { background: #2ecc71; color: white; border: none; }
        .btn-break { background: #f1c40f; border: none; }
    </style>
</head>
<body>
    <style>
    .form-section { background: #e9ecef; padding: 20px; border-radius: 10px; margin-bottom: 30px; display: flex; gap: 20px; flex-wrap: wrap; }
    .form-group { display: flex; flex-direction: column; gap: 5px; }
    input, select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    h2 { margin-top: 0; width: 100%; font-size: 1.2rem; }
</style>
<div class="form-section">
    <h2>üì¢ –ë–µ–≥—É—â–∞—è —Å—Ç—Ä–æ–∫–∞</h2>
    <div class="form-group" style="flex: 1;">
        <input type="text" id="ticker-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –æ–±—ä—è–≤–ª–µ–Ω–∏—è..." style="width: 100%;">
    </div>
    <button onclick="updateTicker()" style="background: #f39c12; color: white; border: none; border-radius: 5px; padding: 10px 20px;">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É</button>
</div>

<script>
    // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤ –±–ª–æ–∫ <script>
    async function updateTicker() {
        const text = document.getElementById('ticker-input').value;
        const res = await fetch('/api/update-ticker', {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ text: text })
        });
        if (res.ok) alert('–¢–µ–∫—Å—Ç —Å—Ç—Ä–æ–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω!');
    }

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ñ—É–Ω–∫—Ü–∏—é loadAdmin, —á—Ç–æ–±—ã –æ–Ω–∞ –ø–æ–¥–≥—Ä—É–∂–∞–ª–∞ —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç –≤ –∏–Ω–ø—É—Ç
    async function loadAdmin() {
        // ... (–≤–∞—à —Å—Ç–∞—Ä—ã–π –∫–æ–¥) ...
        const res = await fetch('/api/get-display');
        const data = await res.json();
        document.getElementById('ticker-input').value = data.ticker; // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç
        // ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥) ...
    }
</script>
<div class="form-section">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</h2>
    <div class="form-group">
        <input type="text" id="new-doc-name" placeholder="–§–ò–û –≤—Ä–∞—á–∞">
    </div>
    <div class="form-group">
        <input type="text" id="new-doc-spec" placeholder="–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è">
    </div>
    <button onclick="saveDoctor()" style="background: #007bff; color: white; border: none; border-radius: 5px; padding: 10px 20px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Ä–∞—á–∞</button>
</div>

<div class="form-section">
    <h2>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞–±–∏–Ω–µ—Ç</h2>
    <div class="form-group">
        <input type="text" id="new-room-num" placeholder="‚Ññ –∫–∞–±–∏–Ω–µ—Ç–∞">
    </div>
    <div class="form-group">
        <select id="doc-select">
            <option value="">–ë–µ–∑ –≤—Ä–∞—á–∞</option>
            </select>
    </div>
    <button onclick="saveRoom()" style="background: #28a745; color: white; border: none; border-radius: 5px; padding: 10px 20px;">–°–æ–∑–¥–∞—Ç—å –∫–∞–±–∏–Ω–µ—Ç</button>
</div>

<hr>

<script>
    // –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Ä–∞—á–µ–π –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
    async function updateDoctorSelect() {
        const res = await fetch('/api/doctors');
        const doctors = await res.json();
        const select = document.getElementById('doc-select');
        select.innerHTML = '<option value="">–ë–µ–∑ –≤—Ä–∞—á–∞</option>' +
            doctors.map(d => `<option value="${d.id}">${d.full_name}</option>`).join('');
    }

    async function saveDoctor() {
    const name = document.getElementById('new-doc-name').value;
    const spec = document.getElementById('new-doc-spec').value;

    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç–æ—Ç—É
    if (!name || !spec) {
        alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∏ —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é!");
        return;
    }

    const response = await fetch('/api/doctors', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            full_name: name,         // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–∞–∫ –≤ –ë—ç–∫–µ–Ω–¥–µ
            specialization: spec     // –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ —Ç–æ—á–Ω–æ—Å—Ç–∏ –∫–∞–∫ –≤ –ë—ç–∫–µ–Ω–¥–µ
        })
    });

    if (response.ok) {
        document.getElementById('new-doc-name').value = '';
        document.getElementById('new-doc-spec').value = '';
        updateDoctorSelect();
        alert('–í—Ä–∞—á –¥–æ–±–∞–≤–ª–µ–Ω');
    } else {
        const error = await response.json();
        console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:", error.detail);
        alert('–û—à–∏–±–∫–∞ 422: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞');
    }
}

    async function saveRoom() {
    const num = document.getElementById('new-room-num').value;
    const docId = document.getElementById('doc-select').value;

    // –ï—Å–ª–∏ –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞ –ø—É—Å—Ç–æ–π, –ø—Ä–µ—Ä—ã–≤–∞–µ–º
    if (!num) {
        alert("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞–±–∏–Ω–µ—Ç–∞!");
        return;
    }

    try {
        const response = await fetch('/api/rooms', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                number: num,
                doctor_id: docId ? parseInt(docId) : null
            })
        });

        if (response.ok) {
            document.getElementById('new-room-num').value = '';
            // –°–Ω–∞—á–∞–ª–∞ –∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤ –∑–∞–Ω–æ–≤–æ
            await loadAdmin();
            alert('–ö–∞–±–∏–Ω–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!');
        } else {
            // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –≤—ã–≤–æ–¥–∏–º –µ—ë —Ç–µ–∫—Å—Ç
            const errorData = await response.json();
            console.error("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞:", errorData);
            alert('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ' + JSON.stringify(errorData.detail));
        }
    } catch (err) {
        console.error("–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞:", err);
    }
}

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    updateDoctorSelect();
</script>
    <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–∞–º–∏</h1>
    <div id="admin-list"></div>

    <script>
        // –•—Ä–∞–Ω–∏–º –≤—Ä–∞—á–µ–π –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
let allDoctors = [];

async function loadAdmin() {
    // 1. –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º —Å–≤–µ–∂–∏–π —Å–ø–∏—Å–æ–∫ –≤—Ä–∞—á–µ–π
    const docRes = await fetch('/api/doctors');
    allDoctors = await docRes.json();

    // 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–±–∏–Ω–µ—Ç–æ–≤
    const res = await fetch('/api/get-display');
    const data = await res.json();

    const container = document.getElementById('admin-list');
    container.innerHTML = data.rooms.map(r => `
        <div class="admin-card">
            <div style="flex: 1">
                <input type="text" value="${r.number}" style="width: 50px"
                       onchange="updateRoomDetails(${r.id}, {number: this.value})">

                <select onchange="updateRoomDetails(${r.id}, {doctor_id: parseInt(this.value)})">
                    <option value="0">-- –ù–µ—Ç –≤—Ä–∞—á–∞ --</option>
                    ${allDoctors.map(d => `
                        <option value="${d.id}" ${r.doctor_name === d.full_name ? 'selected' : ''}>
                            ${d.full_name}
                        </option>
                    `).join('')}
                </select>
            </div>

            <div style="flex: 1">
                <button class="btn-active" onclick="updateStatus(${r.id}, 'active')">–ü—Ä–∏–µ–º</button>
                <button class="btn-break" onclick="updateStatus(${r.id}, 'break')">–ü–µ—Ä–µ—Ä—ã–≤</button>
                <button onclick="updateStatus(${r.id}, 'vacation')" style="background: #9b59b6; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">–û—Ç–ø—É—Å–∫</button>
                <input type="text" id="note-${r.id}" placeholder="–ó–∞–º–µ—Ç–∫–∞" value="${r.status_note}" style="width: 100px">
            </div>

            <button onclick="deleteRoom(${r.id})" style="background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                üóë –£–¥–∞–ª–∏—Ç—å
            </button>
        </div>
    `).join('');
}

async function updateRoomDetails(roomId, payload) {
    await fetch(`/api/rooms/${roomId}/details`, {
        method: 'PATCH',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(payload)
    });
    // –¢–∞–±–ª–æ –æ–±–Ω–æ–≤–∏—Ç—Å—è —Å–∞–º–æ —á–µ—Ä–µ–∑ WebSocket, –∞ —Ç—É—Ç –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–∏–º –ª–æ–∫–∞–ª—å–Ω–æ
    console.log("Details updated");
}

async function deleteRoom(roomId) {
    if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –∫–∞–±–∏–Ω–µ—Ç?")) return;

    const res = await fetch(`/api/rooms/${roomId}`, { method: 'DELETE' });
    if (res.ok) {
        loadAdmin();
    }
}

        async function updateStatus(roomId, status) {
    const note = document.getElementById(`note-${roomId}`).value;

    const response = await fetch('/api/update-status', {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            room_id: roomId,
            status: status,
            status_note: note
        })
    });

    if (response.ok) {
        console.log("–°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ");
        // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç –Ω–∞–∂–∞—Ç–∏—è
    } else {
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏");
    }
}
        loadAdmin();
    </script>
</body>
</html>
